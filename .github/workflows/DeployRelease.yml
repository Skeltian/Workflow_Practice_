name: "Deploy release"

on:
  push:
    branches:
      - master

jobs:
  job:
    runs-on: [self-hosted]
    steps:
      - name: "Checkout my repository"
        uses: actions/checkout@v2
        
      - name: "Create the paclet file"
        run: |
          $FILES = @(Get-ChildItem -Path './') | Where-Object {$_ -notlike ".github" -and $_ -notlike "Resources_"};
          echo $FILES;
          wolframscript -script "./Resources_/Scripts_/DeployRelease.wls" $FILES
        
      - name: "Commit the files"
        run: |
          git add *
          git commit -m "Auto-generated and handled the PacletSite creation"
          git push -u origin
  job2:
    runs-on: ubuntu-latest
    needs: [job]
    outputs:
      tag: ${{ steps.tagCreation.outputs.new_tag }}
    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v2
        with:
          fetch-depth: '0'
      - name: "Bump version and push tag"
        id: tagCreation
        uses: anothrNick/github-tag-action@1.36.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          DEFAULT_BUMP: 'major'
  job3:
    runs-on: ubuntu-latest
    needs: [job2]
    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v2
      - name: "Create release"
        uses: ncipollo/release-action@v1
        with:
          repo: "master"
          generateReleaseNotes: true
          tag: ${{ needs.job2.outputs.tag }}
